<!DOCTYPE html><html lang="en"><head><!-- hexo injector head_begin start --><link href="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.0.5/css/index.css" rel="stylesheet"/><!-- hexo injector head_begin end --><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="jiancheng_wang"><meta name="copyright" content="jiancheng_wang"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>flink | çŒ«ä¹å¤§å¤§ã®Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.21/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"jianchengwang.info","root":"/","title":["çŒ«","ä¹","å¤§","å¤§","ã®","Blog"],"version":"1.2.0","mode":"auto","copycode":true,"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><script src="https://cdn.jsdelivr.net/gh/jianchengwang/live2d_models@main/assets/js/live2dv3.init.js"></script><meta name="description" content="Apache Flink æ˜¯ä¸€ä¸ªåœ¨æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµä¸Šè¿›è¡ŒçŠ¶æ€è®¡ç®—çš„æ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†å¼•æ“.Flink å·²ç»å¯ä»¥åœ¨æ‰€æœ‰å¸¸è§çš„é›†ç¾¤ç¯å¢ƒä¸­è¿è¡Œ,å¹¶ä»¥ in-memory çš„é€Ÿåº¦å’Œä»»æ„çš„è§„æ¨¡è¿›è¡Œè®¡ç®—. å¯ä»¥ç±»æ¯” spring batch æˆ–è€…sparkè¿›è¡Œå­¦ä¹ ,åŸºæœ¬æµç¨‹å°±æ˜¯source-&gt;computer&#x2F;transformation-&gt;sink æœ¬æ–‡ç« çš„å¤§éƒ¨åˆ†æ–‡å­—éƒ½æ¥æºäºäº’è”ç½‘,æœ€åº•ä¸‹ä¼šé™„ä¸Šé“¾">
<meta property="og:type" content="article">
<meta property="og:title" content="flink">
<meta property="og:url" content="https://jianchengwang.info/2020/11/03/java/middleware/flink/index.html">
<meta property="og:site_name" content="çŒ«ä¹å¤§å¤§ã®Blog">
<meta property="og:description" content="Apache Flink æ˜¯ä¸€ä¸ªåœ¨æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµä¸Šè¿›è¡ŒçŠ¶æ€è®¡ç®—çš„æ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†å¼•æ“.Flink å·²ç»å¯ä»¥åœ¨æ‰€æœ‰å¸¸è§çš„é›†ç¾¤ç¯å¢ƒä¸­è¿è¡Œ,å¹¶ä»¥ in-memory çš„é€Ÿåº¦å’Œä»»æ„çš„è§„æ¨¡è¿›è¡Œè®¡ç®—. å¯ä»¥ç±»æ¯” spring batch æˆ–è€…sparkè¿›è¡Œå­¦ä¹ ,åŸºæœ¬æµç¨‹å°±æ˜¯source-&gt;computer&#x2F;transformation-&gt;sink æœ¬æ–‡ç« çš„å¤§éƒ¨åˆ†æ–‡å­—éƒ½æ¥æºäºäº’è”ç½‘,æœ€åº•ä¸‹ä¼šé™„ä¸Šé“¾">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-11-03T10:24:17.281Z">
<meta property="article:modified_time" content="2020-11-03T10:24:17.281Z">
<meta property="article:author" content="jiancheng_wang">
<meta property="article:tag" content="flink">
<meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="jiancheng_wang"><img width="96" loading="lazy" src="https://blog.res.jianchengwang.info/avatar.jpg" alt="jiancheng_wang"><span class="site-author-status" title="balabala....">ğŸ˜Š</span></a><div class="site-author-name"><a href="/about/">jiancheng_wang</a></div><a class="site-name" href="/about/site.html">çŒ«ä¹å¤§å¤§ã®Blog</a><sub class="site-subtitle">Have fun and enjoy every day</sub><div class="site-desciption">balabala...</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">27</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">19</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">24</span></a></div><a class="site-state-item hty-icon-button" href="/albums" title="Albums"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-gallery-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/jianchengwang" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:jianchengwang80@gmail.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/wjc750145113" title="Weibo" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://files.jianchengwang.info/" title="Files" target="_blank" style="color:blue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.now.sh/" title="Travelling" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-send-plane-2-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="Friend Links" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a><a class="links-item hty-icon-button" href="/girls/" title="Lovely Girls" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#QuickStart"><span class="toc-number">1.</span> <span class="toc-text">QuickStart</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.</span> <span class="toc-text">æ­å»ºæ‰§è¡Œç¯å¢ƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">åˆ›å»ºåº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataStream-API"><span class="toc-number">2.</span> <span class="toc-text">DataStream API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DataSource"><span class="toc-number">2.1.</span> <span class="toc-text">DataSource</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.1.1.</span> <span class="toc-text">å†…ç½®æ•°æ®æº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Elements"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">Elements</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#File"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">File</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Socket"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">Socket</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.1.2.</span> <span class="toc-text">å¤–éƒ¨æ•°æ®æº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">ç¬¬ä¸‰æ–¹æ•°æ®æº</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">è‡ªå®šä¹‰æ•°æ®æº</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transformation"><span class="toc-number">2.2.</span> <span class="toc-text">Transformation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-number">2.2.1.</span> <span class="toc-text">åŸºæœ¬è½¬æ¢ç®—å­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#filter"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">filter</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#map"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">map</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#flatMap"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">flatMap</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#richFunction"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">richFunction</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%AE%E6%8E%A7%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-number">2.2.2.</span> <span class="toc-text">é”®æ§æµè½¬æ¢ç®—å­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#keyBy"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">keyBy</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#fold"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">fold</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#aggregate"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">aggregate</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#window"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">window</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#window-join"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">window join</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#split"><span class="toc-number">2.2.2.6.</span> <span class="toc-text">split</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#select"><span class="toc-number">2.2.2.7.</span> <span class="toc-text">select</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#project"><span class="toc-number">2.2.2.8.</span> <span class="toc-text">project</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#reduce"><span class="toc-number">2.2.2.9.</span> <span class="toc-text">reduce</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-number">2.2.3.</span> <span class="toc-text">å¤šæµè½¬æ¢ç®—å­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#union"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">union</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#connect-comap-coflatmap"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">connect,comap,coflatmap</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-number">2.2.4.</span> <span class="toc-text">åˆ†å¸ƒå¼è½¬æ¢ç®—å­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#random"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">random</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#round-robin"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">round-robin</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#rescale"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">rescale</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#broadcast"><span class="toc-number">2.2.4.4.</span> <span class="toc-text">broadcast</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#global"><span class="toc-number">2.2.4.5.</span> <span class="toc-text">global</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#custom"><span class="toc-number">2.2.4.6.</span> <span class="toc-text">custom</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sink"><span class="toc-number">2.3.</span> <span class="toc-text">Sink</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9sink"><span class="toc-number">2.3.1.</span> <span class="toc-text">ç¬¬ä¸‰æ–¹sink</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#kafka"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">kafka</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#redis"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">redis</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#elasticsearch"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">elasticsearch</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89sink"><span class="toc-number">2.3.2.</span> <span class="toc-text">è‡ªå®šä¹‰sink</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Window"><span class="toc-number">2.4.</span> <span class="toc-text">Window</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4-time"><span class="toc-number">2.4.1.</span> <span class="toc-text">æ—¶é—´ time</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B0%B4%E4%BD%8D%E7%BA%BF-watermark"><span class="toc-number">2.4.2.</span> <span class="toc-text">æ°´ä½çº¿ watermark</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%B0%B4%E5%8D%B0"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">ä½¿ç”¨æ°´å°</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#event%E6%97%B6%E9%97%B4%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">eventæ—¶é—´çš„è·å–</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E7%A9%BA%E9%97%B2%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">å¤„ç†ç©ºé—²æ•°æ®æº</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E7%AE%80%E4%BB%8B-window"><span class="toc-number">2.4.3.</span> <span class="toc-text">çª—å£ç®€ä»‹ window</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Window-Assigner"><span class="toc-number">2.4.4.</span> <span class="toc-text">Window Assigner</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3-Tumbling-Windows"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">æ»šåŠ¨çª—å£ Tumbling Windows</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3-Sliding-Window"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">æ»‘åŠ¨çª—å£ Sliding Window</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3-Session-Window"><span class="toc-number">2.4.4.3.</span> <span class="toc-text">ä¼šè¯çª—å£ Session Window</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%AA%97%E5%8F%A3-Global-Window"><span class="toc-number">2.4.4.4.</span> <span class="toc-text">å…¨å±€çª—å£ Global Window</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Window-Function"><span class="toc-number">2.4.5.</span> <span class="toc-text">Window Function</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ReduceFunction-%E5%A2%9E%E9%87%8F"><span class="toc-number">2.4.5.1.</span> <span class="toc-text">ReduceFunction (å¢é‡)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#AggregateFunction-%E5%A2%9E%E9%87%8F"><span class="toc-number">2.4.5.2.</span> <span class="toc-text">AggregateFunction (å¢é‡)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#FoldFunction-%E5%A2%9E%E9%87%8F"><span class="toc-number">2.4.5.3.</span> <span class="toc-text">FoldFunction (å¢é‡)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ProcessWindowFunction-%E5%85%A8%E9%87%8F"><span class="toc-number">2.4.5.4.</span> <span class="toc-text">ProcessWindowFunction (å…¨é‡)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Window-Join"><span class="toc-number">2.4.6.</span> <span class="toc-text">Window Join</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E8%BF%9F%E5%88%B0%E7%9A%84%E5%85%83%E7%B4%A0"><span class="toc-number">2.4.7.</span> <span class="toc-text">å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ </span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E6%8A%9B%E5%BC%83"><span class="toc-number">2.4.7.1.</span> <span class="toc-text">ç›´æ¥æŠ›å¼ƒ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">2.4.7.2.</span> <span class="toc-text">é‡å®šå‘</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%AA%97%E5%8F%A3%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C"><span class="toc-number">2.4.7.3.</span> <span class="toc-text">æ›´æ–°çª—å£è®¡ç®—ç»“æœ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#State"><span class="toc-number">2.5.</span> <span class="toc-text">State</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Table"><span class="toc-number">2.6.</span> <span class="toc-text">Table</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="toc-number">3.</span> <span class="toc-text">ç›¸å…³é“¾æ¥</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://jianchengwang.info/2020/11/03/java/middleware/flink/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="jiancheng_wang"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="çŒ«ä¹å¤§å¤§ã®Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">flink<a class="post-edit-link" href="https://github.com/jianchengwang/jianchengwang.github.io/tree/hexo/source/_posts/java/middleware/flink.md" target="_blank" title="Edit this post" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2020-11-03 18:24:17" itemprop="dateCreated datePublished" datetime="2020-11-03T18:24:17+08:00">2020-11-03</time></div><div class="post-classify"><span class="post-category"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">java</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/java/middleware/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">middleware</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/flink/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">flink</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><p><strong>Apache Flink</strong> æ˜¯ä¸€ä¸ªåœ¨æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµä¸Šè¿›è¡ŒçŠ¶æ€è®¡ç®—çš„æ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†å¼•æ“.Flink å·²ç»å¯ä»¥åœ¨æ‰€æœ‰å¸¸è§çš„é›†ç¾¤ç¯å¢ƒä¸­è¿è¡Œ,å¹¶ä»¥ in-memory çš„é€Ÿåº¦å’Œä»»æ„çš„è§„æ¨¡è¿›è¡Œè®¡ç®—.</p>
<p>å¯ä»¥ç±»æ¯” <strong>spring batch</strong> æˆ–è€…<strong>spark</strong>è¿›è¡Œå­¦ä¹ ,åŸºæœ¬æµç¨‹å°±æ˜¯<strong>source-&gt;computer/transformation-&gt;sink</strong></p>
<p>æœ¬æ–‡ç« çš„å¤§éƒ¨åˆ†æ–‡å­—éƒ½æ¥æºäºäº’è”ç½‘,æœ€åº•ä¸‹ä¼šé™„ä¸Šé“¾æ¥.</p>
<a id="more"></a>

<h3 id="QuickStart"><a href="#QuickStart" class="headerlink" title="QuickStart"></a>QuickStart</h3><h4 id="æ­å»ºæ‰§è¡Œç¯å¢ƒ"><a href="#æ­å»ºæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="æ­å»ºæ‰§è¡Œç¯å¢ƒ"></a>æ­å»ºæ‰§è¡Œç¯å¢ƒ</h4><p>è¿™è¾¹é€šè¿‡ <strong>docker-compose</strong> æ„å»º,å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶ç‰ˆæœ¬äº†,<a target="_blank" rel="noopener" href="https://flink.apache.org/downloads.html">download</a></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">jobmanager</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flink
    <span class="token key atrule">expose</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"6123"</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8081:8081"</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> jobmanager
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> JOB_MANAGER_RPC_ADDRESS=jobmanager
  <span class="token key atrule">taskmanager</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flink
    <span class="token key atrule">expose</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"6121"</span>
      <span class="token punctuation">-</span> <span class="token string">"6122"</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> jobmanager
    <span class="token key atrule">command</span><span class="token punctuation">:</span> taskmanager
    <span class="token key atrule">links</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"jobmanager:jobmanager"</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> JOB_MANAGER_RPC_ADDRESS=jobmanager</code></pre>

<h4 id="åˆ›å»ºåº”ç”¨"><a href="#åˆ›å»ºåº”ç”¨" class="headerlink" title="åˆ›å»ºåº”ç”¨"></a>åˆ›å»ºåº”ç”¨</h4><p>è¿™é‡Œæ ¹æ®åˆ›å»ºä¸€ä¸ª<code>WordCount</code>åº”ç”¨</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">buildscript <span class="token punctuation">&#123;</span>
    repositories <span class="token punctuation">&#123;</span>
        <span class="token function">jcenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// this applies only to the Gradle 'Shadow' plugin</span>
    <span class="token punctuation">&#125;</span>
    dependencies <span class="token punctuation">&#123;</span>
        classpath <span class="token string">'com.github.jengelman.gradle.plugins:shadow:2.0.4'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
plugins <span class="token punctuation">&#123;</span>
    id <span class="token string">'java'</span>
    id <span class="token string">'application'</span>
    <span class="token comment">// shadow plugin to produce fat JARs</span>
    id <span class="token string">'com.github.johnrengelman.shadow'</span> version <span class="token string">'2.0.4'</span>
<span class="token punctuation">&#125;</span>

configurations <span class="token punctuation">&#123;</span>
    flinkShadowJar <span class="token comment">// dependencies which go into the shadowJar</span>

    <span class="token comment">// always exclude these (also from transitive dependencies) since they are provided by Flink</span>
    flinkShadowJar<span class="token punctuation">.</span>exclude group<span class="token punctuation">:</span> <span class="token string">'org.apache.flink'</span><span class="token punctuation">,</span> module<span class="token punctuation">:</span> <span class="token string">'force-shading'</span>
    flinkShadowJar<span class="token punctuation">.</span>exclude group<span class="token punctuation">:</span> <span class="token string">'com.google.code.findbugs'</span><span class="token punctuation">,</span> module<span class="token punctuation">:</span> <span class="token string">'jsr305'</span>
    flinkShadowJar<span class="token punctuation">.</span>exclude group<span class="token punctuation">:</span> <span class="token string">'org.slf4j'</span>
    flinkShadowJar<span class="token punctuation">.</span>exclude group<span class="token punctuation">:</span> <span class="token string">'org.apache.logging.log4j'</span>
<span class="token punctuation">&#125;</span>

ext <span class="token punctuation">&#123;</span>
    javaVersion <span class="token operator">=</span> <span class="token string">'1.8'</span>
    flinkVersion <span class="token operator">=</span> <span class="token string">'1.11.2'</span>
    scalaBinaryVersion <span class="token operator">=</span> <span class="token string">'2.12'</span>
    slf4jVersion <span class="token operator">=</span> <span class="token string">'1.7.15'</span>
    log4jVersion <span class="token operator">=</span> <span class="token string">'2.12.1'</span>
<span class="token punctuation">&#125;</span>

dependencies <span class="token punctuation">&#123;</span>
    compile <span class="token string gstring">"org.apache.flink:flink-streaming-java_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>scalaBinaryVersion<span class="token punctuation">&#125;</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>flinkVersion<span class="token punctuation">&#125;</span></span>"</span>
    compile <span class="token string gstring">"org.apache.flink:flink-clients_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>scalaBinaryVersion<span class="token punctuation">&#125;</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>flinkVersion<span class="token punctuation">&#125;</span></span>"</span>
    compile <span class="token string gstring">"org.apache.flink:flink-connector-kafka_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>scalaBinaryVersion<span class="token punctuation">&#125;</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>fflinkVersion<span class="token punctuation">&#125;</span></span>"</span>
    compile <span class="token string">'org.slf4j:slf4j-simple:1.7.21'</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// make compileOnly dependencies available for tests:</span>
sourceSets <span class="token punctuation">&#123;</span>
    main<span class="token punctuation">.</span>compileClasspath <span class="token operator">+=</span> configurations<span class="token punctuation">.</span>flinkShadowJar
    main<span class="token punctuation">.</span>runtimeClasspath <span class="token operator">+=</span> configurations<span class="token punctuation">.</span>flinkShadowJar

    test<span class="token punctuation">.</span>compileClasspath <span class="token operator">+=</span> configurations<span class="token punctuation">.</span>flinkShadowJar
    test<span class="token punctuation">.</span>runtimeClasspath <span class="token operator">+=</span> configurations<span class="token punctuation">.</span>flinkShadowJar

    javadoc<span class="token punctuation">.</span>classpath <span class="token operator">+=</span> configurations<span class="token punctuation">.</span>flinkShadowJar
<span class="token punctuation">&#125;</span>

run<span class="token punctuation">.</span>classpath <span class="token operator">=</span> sourceSets<span class="token punctuation">.</span>main<span class="token punctuation">.</span>runtimeClasspath

jar <span class="token punctuation">&#123;</span>
    manifest <span class="token punctuation">&#123;</span>
        attributes <span class="token string">'Built-By'</span><span class="token punctuation">:</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">'user.name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'Build-Jdk'</span><span class="token punctuation">:</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">'java.version'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

shadowJar <span class="token punctuation">&#123;</span>
    configurations <span class="token operator">=</span> <span class="token punctuation">[</span>project<span class="token punctuation">.</span>configurations<span class="token punctuation">.</span>flinkShadowJar<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCount</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// è·å–æœ¬åœ°æ‰§è¡Œç¯å¢ƒ</span>
        <span class="token keyword">final</span> <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®å¹¶è¡Œæ•°é‡</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–æ•°æ®æµ</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è½¬æ¢ç®—å­å¤„ç†æ•°æ®æµå¹¶è¾“å‡ºç»“æœ</span>
        stream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tokenizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>r <span class="token operator">-></span> r<span class="token punctuation">.</span>f0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ‰§è¡Œ</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"Flink Streaming Java API Skeleton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Tokenizer</span> <span class="token keyword">implements</span> <span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> stringList <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> stringList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// ä½¿ç”¨out.collectæ–¹æ³•å‘ä¸‹æ¸¸å‘é€æ•°æ®</span>
                out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>å¦‚æœæ˜¯åœ¨<strong>IDEA</strong>æœ¬åœ°è¿è¡Œçš„è¯,è®°å¾—å¼•å…¥ä¾èµ–<code>flink-clients</code></p>
<pre class="language-shell" data-language="shell"><code class="language-shell">nc -lk 9999</code></pre>

<p>å¦‚æœï¼Œå·²ç»æ­å»ºå¥½äº† <strong>Flink WebUI</strong> è¿è¡Œç¯å¢ƒ,ä¸Šä¼ æäº¤ç¼–è¯‘å¥½çš„jaråŒ… <strong>JobGraph</strong> å³å¯,æˆ–è€…é€šè¿‡å‘½ä»¤è¡Œè¿è¡Œ</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">flink run -c todo.lib.flink.WordCount WordCount.jar</code></pre>

<h3 id="DataStream-API"><a href="#DataStream-API" class="headerlink" title="DataStream API"></a>DataStream API</h3><h4 id="DataSource"><a href="#DataSource" class="headerlink" title="DataSource"></a>DataSource</h4><h5 id="å†…ç½®æ•°æ®æº"><a href="#å†…ç½®æ•°æ®æº" class="headerlink" title="å†…ç½®æ•°æ®æº"></a>å†…ç½®æ•°æ®æº</h5><h6 id="Elements"><a href="#Elements" class="headerlink" title="Elements"></a>Elements</h6><p>ä»æ•°ç»„æˆ–è€…é›†åˆï¼Œä¸€èˆ¬æœ¬åœ°è°ƒè¯•ä½¿ç”¨</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elementInput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"hello Flink"</span><span class="token punctuation">,</span> <span class="token string">"Second Line"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>elementInput<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="File"><a href="#File" class="headerlink" title="File"></a>File</h6><p>å¯ä»¥ä½¿ç”¨ <code>readTextFile</code> æ–¹æ³•ç›´æ¥è¯»å–æ–‡æœ¬æ–‡ä»¶, è¿™ç§æ–¹å¼å¯ä»¥ç”¨æ¥ç›‘æ§ä¸€ä¸‹ <strong>log</strong> æ—¥å¿—æ–‡ä»¶, ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>readFile</code> æ–¹æ³•é€šè¿‡æŒ‡å®š <code>InputFormat</code> æ¥è¯»å–ç‰¹å®šæ•°æ®ç±»å‹çš„æ–‡ä»¶, <code>InputFormat</code>å¯ä»¥æ˜¯å†…ç½®ç±»,å¦‚ <code>CsvInputFormat</code> æˆ–è€…ç”¨æˆ·è‡ªå®šä¹‰ <code>InputFormat</code> æ¥å£ç±».</p>
<p>åœ¨ <code>readFile()</code> æ–¹æ³•ä¸­æœ‰ä¸€é¡¹å‚æ•°ä¸º <code>WatchType</code>, å…±æœ‰ä¸¤ç§æ¨¡å¼ (<code>PROCESS_CONTINUOUSLY </code>/ <code>PROCESS_ONCE</code>). åœ¨ <code>PROCESS_CONTINUOUSLY</code> æ¨¡å¼ä¸‹, æ£€æµ‹åˆ°æ–‡ä»¶å˜åŠ¨å°±ä¼šå°†æ–‡ä»¶å…¨éƒ¨å†…å®¹åŠ è½½åœ¨ <strong>flink</strong>, åœ¨ <code>PROCESS_ONCE</code> æ¨¡å¼ä¸‹, åªä¼šå°†æ–‡ä»¶å˜åŠ¨çš„é‚£éƒ¨åˆ†åŠ è½½åˆ° <strong>flink</strong>.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// æ·»åŠ æ–‡ä»¶æº</span>
<span class="token comment">// ç›´æ¥è¯»å–æ–‡æœ¬æ–‡ä»¶</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>logPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è¯»å–csv</span>
<span class="token class-name">CsvInputFormat</span> csvInput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RowCsvInputFormat</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>csvPath<span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token comment">// æ–‡ä»¶è·¯å¾„</span>
    <span class="token keyword">new</span> <span class="token class-name">TypeInformation</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Types</span><span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>STRING<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token comment">// å­—æ®µç±»å‹</span>
    <span class="token string">"\n"</span><span class="token punctuation">,</span>                                             <span class="token comment">// è¡Œåˆ†éš”ç¬¦</span>
    <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment">// å­—æ®µåˆ†éš”ç¬¦</span>
csvInput<span class="token punctuation">.</span><span class="token function">setSkipFirstLineAsHeader</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æŒ‡å®š CsvInputFormat, ç›‘æ§csvæ–‡ä»¶(ä¸¤ç§æ¨¡å¼), æ—¶é—´é—´éš”æ˜¯10ms</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>csvInput<span class="token punctuation">,</span> csvPath<span class="token punctuation">,</span> <span class="token class-name">FileProcessingMode</span><span class="token punctuation">.</span>PROCESS_CONTINUOUSLY<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h6><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// æ·»åŠ Socketä½œä¸ºæ•°æ®è¾“å…¥æº</span>
<span class="token comment">// 4ä¸ªå‚æ•° -> (hostname:Ipåœ°å€, port:ç«¯å£, delimiter:åˆ†éš”ç¬¦, maxRetry:æœ€å¤§é‡è¯•æ¬¡æ•°)</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h5 id="å¤–éƒ¨æ•°æ®æº"><a href="#å¤–éƒ¨æ•°æ®æº" class="headerlink" title="å¤–éƒ¨æ•°æ®æº"></a>å¤–éƒ¨æ•°æ®æº</h5><p>å¤–éƒ¨æ•°æ®æºæ˜¯é‡å¤´æˆ, ä¸€èˆ¬æ¥è¯´é¡¹ç›®ä¸­å‡æ˜¯ä½¿ç”¨å¤–éƒ¨æ•°æ®æºä½œä¸ºæ•°æ®çš„æºå¤´.</p>
<h6 id="ç¬¬ä¸‰æ–¹æ•°æ®æº"><a href="#ç¬¬ä¸‰æ–¹æ•°æ®æº" class="headerlink" title="ç¬¬ä¸‰æ–¹æ•°æ®æº"></a>ç¬¬ä¸‰æ–¹æ•°æ®æº</h6><p>flink é€šè¿‡å®ç° <code>SourceFunction</code> å®šä¹‰äº†éå¸¸ä¸°å¯Œçš„ç¬¬ä¸‰æ–¹æ•°æ®è¿æ¥å™¨.å¯¹äºç¬¬ä¸‰æ–¹æ•°æ®æº, flinkçš„æ”¯æŒåˆ†ä¸ºä¸‰ç§,æœ‰<strong>åªè¯»å‹</strong>(Twitter Streaming API / Netty ), <strong>åªå†™å‹</strong>( Cassandra / Elasticsearch / hadoop FileSystem), æ”¯æŒ<strong>è¯»å†™</strong>(Kafka / Amazon Kinesis / RabbitMQ)</p>
<ul>
<li>Apache Kafka (Source / Sink)</li>
<li>Apache Cassandra (Sink)</li>
<li>Amazon Kinesis Streams (Source / Sink)</li>
<li>Elasticsearch (Sink)</li>
<li>Hadoop FileSystem (Sink)</li>
<li>RabbitMQ (Source / Sink)</li>
<li>Apache NiFI (Source / Sink)</li>
<li>Twitter Streaming API (Source)</li>
<li>Apache Bahir ä¸­çš„è¿æ¥å™¨:</li>
<li>Apache ActiveMQ (Source / Sink)</li>
<li>Apache Flume (Sink)</li>
<li>Redis (Sink)</li>
<li>Akka (Sink)</li>
<li>Netty (Source)</li>
</ul>
<p><strong>ä»¥Kafka ä¸ºä¾‹ åšæ¼”ç¤º</strong></p>
<p>æˆ‘è¿™è¾¹æ˜¯è¿œç¨‹æœåŠ¡å™¨ä¸Š<strong>docker-compose</strong>å¯åŠ¨<strong>kafka</strong>,ä¸»è¦æ³¨æ„ä¸‹é¢çš„<strong>EN_IP</strong>è¡¨ç¤ºå¤–ç½‘çš„IPåœ°å€</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># ä¸€ä¸ª kafkaèŠ‚ç‚¹ å°±æ˜¯ä¸€ä¸ª brokerã€‚ä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ª broker ç»„æˆã€‚ä¸€ä¸ª brokerå¯ä»¥å®¹çº³å¤šä¸ª topic</span>
<span class="token key atrule">KAFKA_BROKER_ID</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token comment"># é…ç½®zookeeperç®¡ç†kafkaçš„è·¯å¾„</span>
<span class="token key atrule">KAFKA_ZOOKEEPER_CONNECT</span><span class="token punctuation">:</span> zookeeper<span class="token punctuation">:</span><span class="token number">2181</span> 
<span class="token comment"># æŠŠkafkaçš„åœ°å€ç«¯å£æ³¨å†Œç»™zookeeperï¼Œè‹¥è¿œç¨‹è®¿é—®è¦æ”¹æˆå¤–ç½‘IP,åƒä¸‡æ³¨æ„æ˜¯å¤–ç½‘IP</span>
<span class="token key atrule">KAFKA_ADVERTISED_LISTENERS</span><span class="token punctuation">:</span> PLAINTEXT<span class="token punctuation">:</span>//$<span class="token punctuation">&#123;</span>EN_IP<span class="token punctuation">&#125;</span><span class="token punctuation">:</span><span class="token number">9092</span> 
<span class="token comment"># é…ç½®kafkaçš„ç›‘å¬ç«¯å£</span>
<span class="token key atrule">KAFKA_LISTENERS</span><span class="token punctuation">:</span> PLAINTEXT<span class="token punctuation">:</span>//0.0.0.0<span class="token punctuation">:</span><span class="token number">9092</span>  </code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"EN_IP:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dataStream <span class="token operator">=</span> env
    <span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<pre class="language-shell" data-language="shell"><code class="language-shell">docker exec -it kafka_container_id bash
cd &#x2F;opt&#x2F;kafka&#x2F;bin
&#x2F;&#x2F; ç”Ÿäº§æ•°æ®
.&#x2F;kafka-console-producer.sh --broker-list EN_IP:9092 --topic flink-test
&#x2F;&#x2F; æ¶ˆè´¹æ•°æ®
.&#x2F;kafka-console-consumer.sh --bootstrap-server EN_IP:9092 --topic flink-test --from-beginning</code></pre>

<h6 id="è‡ªå®šä¹‰æ•°æ®æº"><a href="#è‡ªå®šä¹‰æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰æ•°æ®æº"></a>è‡ªå®šä¹‰æ•°æ®æº</h6><p>ç”¨æˆ·ä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰è¿æ¥å™¨, é€šè¿‡å®ç° <code>SourceFunction</code> å®šä¹‰å•ä¸ªçº¿ç¨‹çš„æ¥å…¥çš„æ•°æ®è¿æ¥å™¨, ä¹Ÿå¯ä»¥é€šè¿‡å®ç°<code>ParallelSourceFunction</code> æ¥å£æˆ–è€…ç»§æ‰¿ <code>RichParallelSourceFunction</code> ç±»å®šä¹‰å¹¶å‘æ•°æ®æºæ¥å…¥å™¨.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">SourceFromMySQL</span> <span class="token keyword">extends</span> <span class="token class-name">RichSourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>
                resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>



<h4 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h4><h5 id="åŸºæœ¬è½¬æ¢ç®—å­"><a href="#åŸºæœ¬è½¬æ¢ç®—å­" class="headerlink" title="åŸºæœ¬è½¬æ¢ç®—å­"></a>åŸºæœ¬è½¬æ¢ç®—å­</h5><p>åŸºæœ¬è½¬æ¢ç®—å­ä¼šé’ˆå¯¹æµä¸­çš„æ¯ä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶åšå¤„ç†,ä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªè¾“å…¥æ•°æ®ä¼šäº§ç”Ÿä¸€ä¸ªè¾“å‡ºæ•°æ®.å•å€¼è½¬æ¢,æ•°æ®çš„åˆ†å‰²,æ•°æ®çš„è¿‡æ»¤,éƒ½æ˜¯åŸºæœ¬è½¬æ¢æ“ä½œçš„å…¸å‹ä¾‹å­.è¿™ä¸ªæœ‰ä¸ªæ¦‚å¿µå°±è¡Œ,å¯ä»¥è·³è¿‡.</p>
<h6 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h6><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">></span></span> filteredReadings <span class="token operator">=</span> readings<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>r <span class="token operator">-></span> r<span class="token punctuation">.</span>temperature <span class="token operator">>=</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="map"><a href="#map" class="headerlink" title="map"></a>map</h6><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> sensorIds <span class="token operator">=</span> filteredReadings<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">-></span> r<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap"></a>flatMap</h6><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> splitIds <span class="token operator">=</span> sensorIds
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>
             <span class="token punctuation">(</span>id<span class="token punctuation">,</span> out<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token operator">:</span> id<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token comment">// provide result type because Java cannot infer return type of lambda function</span>
    <span class="token comment">// æä¾›ç»“æœçš„ç±»å‹ï¼Œå› ä¸ºJavaæ— æ³•æ¨æ–­åŒ¿åå‡½æ•°çš„è¿”å›å€¼ç±»å‹</span>
    <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span>STRING<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="richFunction"><a href="#richFunction" class="headerlink" title="richFunction"></a>richFunction</h6><p>åœ¨å‡½æ•°å¤„ç†æ•°æ®ä¹‹å‰,éœ€è¦åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ;æˆ–è€…éœ€è¦åœ¨å¤„ç†æ•°æ®æ—¶å¯ä»¥è·å¾—å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¸€äº›ä¿¡æ¯;ä»¥åŠåœ¨å¤„ç†å®Œæ•°æ®æ—¶åšä¸€äº›æ¸…ç†å·¥ä½œ</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyFlatMap</span> <span class="token keyword">extends</span> <span class="token class-name">RichFlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> subTaskIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> subTaskIndex <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getIndexOfThisSubtask<span class="token punctuation">;</span>
    <span class="token comment">// åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ</span>
    <span class="token comment">// ä¾‹å¦‚å»ºç«‹ä¸€ä¸ªå’ŒHDFSçš„è¿æ¥</span>
  <span class="token punctuation">&#125;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> in<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> subTaskIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>subTaskIndex<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// æ¸…ç†å·¥ä½œï¼Œæ–­å¼€å’ŒHDFSçš„è¿æ¥ã€‚</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="é”®æ§æµè½¬æ¢ç®—å­"><a href="#é”®æ§æµè½¬æ¢ç®—å­" class="headerlink" title="é”®æ§æµè½¬æ¢ç®—å­"></a>é”®æ§æµè½¬æ¢ç®—å­</h5><p>å¾ˆå¤šæµå¤„ç†ç¨‹åºçš„ä¸€ä¸ªåŸºæœ¬è¦æ±‚å°±æ˜¯è¦èƒ½å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„,åˆ†ç»„åçš„æ•°æ®å…±äº«æŸä¸€ä¸ªç›¸åŒçš„å±æ€§.<strong>DataStream API</strong>æä¾›äº†ä¸€ä¸ªå«åš<code>KeyedStream</code>çš„æŠ½è±¡,æ­¤æŠ½è±¡ä¼šä»é€»è¾‘ä¸Šå¯¹DataStreamè¿›è¡Œåˆ†åŒº,åˆ†åŒºåçš„æ•°æ®æ‹¥æœ‰åŒæ ·çš„<code>Key</code>å€¼,åˆ†åŒºåçš„æµäº’ä¸ç›¸å…³.</p>
<h6 id="keyBy"><a href="#keyBy" class="headerlink" title="keyBy"></a>keyBy</h6><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> keyed <span class="token operator">=</span> readings<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>r <span class="token operator">-></span> r<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="fold"><a href="#fold" class="headerlink" title="fold"></a>fold</h6><p>é€šè¿‡å°†æœ€åä¸€ä¸ªæ–‡ä»¶å¤¹æµä¸å½“å‰è®°å½•ç»„åˆæ¥æ¨å‡º KeyedStream.å®ƒä¼šå‘å›æ•°æ®æµ.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">KeyedStream</span><span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FoldFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">fold</span><span class="token punctuation">(</span><span class="token class-name">String</span> accumulator<span class="token punctuation">,</span> <span class="token class-name">Integer</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre>

<h6 id="aggregate"><a href="#aggregate" class="headerlink" title="aggregate"></a>aggregate</h6><p>æ»šåŠ¨èšåˆç®—å­ç”±<code>KeyedStream</code>è°ƒç”¨,å¹¶ç”Ÿæˆä¸€ä¸ªèšåˆä»¥åçš„DataStream.</p>
<p>æ»šåŠ¨èšåˆç®—å­åªèƒ½ç”¨åœ¨æ»šåŠ¨çª—å£,ä¸èƒ½ç”¨åœ¨æ»‘åŠ¨çª—å£.</p>
<p>æ»šåŠ¨èšåˆæ“ä½œä¼šå¯¹æ¯ä¸€ä¸ªkeyéƒ½ä¿å­˜ä¸€ä¸ªçŠ¶æ€ã€‚å› ä¸ºçŠ¶æ€ä»æ¥ä¸ä¼šè¢«æ¸…ç©ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨æ»šåŠ¨èšåˆç®—å­æ—¶åªèƒ½ä½¿ç”¨åœ¨å«æœ‰æœ‰é™ä¸ªkeyçš„æµä¸Šé¢ã€‚</p>
<p>å¸¸è§çš„æ»šåŠ¨èšåˆç®—å­: sum,min,max,minBy,maxBy</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> resultStream <span class="token operator">=</span> inputStream
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// key on first field of the tuple</span>
    <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// sum the second field of the tuple in place</span></code></pre>

<h6 id="window"><a href="#window" class="headerlink" title="window"></a>window</h6><p>å…è®¸æŒ‰æ—¶é—´æˆ–å…¶ä»–æ¡ä»¶å¯¹ç°æœ‰ KeyedStream è¿›è¡Œåˆ†ç»„.ä»¥ä¸‹æ˜¯ä»¥ 10 ç§’çš„æ—¶é—´çª—å£èšåˆ:</p>
<pre class="language-java" data-language="java"><code class="language-java">inputStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inputStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">windowAll</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="window-join"><a href="#window-join" class="headerlink" title="window join"></a>window join</h6><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº› key å°†åŒä¸€ä¸ª window çš„ä¸¤ä¸ªæ•°æ®æµ join èµ·æ¥.</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¯åœ¨ 5 ç§’çš„çª—å£ä¸­è¿æ¥ä¸¤ä¸ªæµ,å…¶ä¸­ç¬¬ä¸€ä¸ªæµçš„ç¬¬ä¸€ä¸ªå±æ€§çš„è¿æ¥æ¡ä»¶ç­‰äºå¦ä¸€ä¸ªæµçš„ç¬¬äºŒä¸ªå±æ€§</p>
<pre class="language-java" data-language="java"><code class="language-java">inputStream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>inputStream1<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     
           <span class="token punctuation">.</span>apply <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JoinFunction</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="split"><a href="#split" class="headerlink" title="split"></a>split</h6><p>æ­¤åŠŸèƒ½æ ¹æ®æ¡ä»¶å°†æµæ‹†åˆ†ä¸ºä¸¤ä¸ªæˆ–å¤šä¸ªæµ.å½“æ‚¨è·å¾—æ··åˆæµå¹¶ä¸”æ‚¨å¯èƒ½å¸Œæœ›å•ç‹¬å¤„ç†æ¯ä¸ªæ•°æ®æµæ—¶,å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">SplitStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> split <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputSelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            output<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"even"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            output<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"odd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> output<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="select"><a href="#select" class="headerlink" title="select"></a>select</h6><p>æ­¤åŠŸèƒ½å…è®¸æ‚¨ä»æ‹†åˆ†æµä¸­é€‰æ‹©ç‰¹å®šæµ</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">SplitStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> split<span class="token punctuation">;</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> even <span class="token operator">=</span> split<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"even"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> odd <span class="token operator">=</span> split<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"odd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> all <span class="token operator">=</span> split<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"even"</span><span class="token punctuation">,</span><span class="token string">"odd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="project"><a href="#project" class="headerlink" title="project"></a>project</h6><p>Project å‡½æ•°å…è®¸æ‚¨ä»äº‹ä»¶æµä¸­é€‰æ‹©å±æ€§å­é›†,å¹¶ä»…å°†æ‰€é€‰å…ƒç´ å‘é€åˆ°ä¸‹ä¸€ä¸ªå¤„ç†æµ.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple4</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> in <span class="token operator">=</span> <span class="token comment">// [...] </span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> out <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h6><p>reduceå‡½æ•°å¯ä»¥é€šè¿‡å®ç°æ¥å£ReduceFunctionæ¥åˆ›å»ºä¸€ä¸ªç±».ReduceFunctionæ¥å£å®šä¹‰äº†<code>reduce()</code>æ–¹æ³•,æ­¤æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªè¾“å…¥äº‹ä»¶,è¾“å…¥ä¸€ä¸ªç›¸åŒç±»å‹çš„äº‹ä»¶.</p>
<p>reduceä½œä¸ºæ»šåŠ¨èšåˆçš„æ³›åŒ–å®ç°,åŒæ ·ä¹Ÿè¦é’ˆå¯¹æ¯ä¸€ä¸ªkeyä¿å­˜çŠ¶æ€.å› ä¸ºçŠ¶æ€ä»æ¥ä¸ä¼šæ¸…ç©º,æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†reduceç®—å­åº”ç”¨åœ¨ä¸€ä¸ªæœ‰é™keyçš„æµä¸Š.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">></span></span> maxTempPerSensor <span class="token operator">=</span> keyed
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r1<span class="token punctuation">.</span>temperature <span class="token operator">></span> r2<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> r1<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> r2<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h5 id="å¤šæµè½¬æ¢ç®—å­"><a href="#å¤šæµè½¬æ¢ç®—å­" class="headerlink" title="å¤šæµè½¬æ¢ç®—å­"></a>å¤šæµè½¬æ¢ç®—å­</h5><p>è®¸å¤šåº”ç”¨éœ€è¦æ‘„å…¥å¤šä¸ªæµå¹¶å°†æµåˆå¹¶å¤„ç†,è¿˜å¯èƒ½éœ€è¦å°†ä¸€æ¡æµåˆ†å‰²æˆå¤šæ¡æµç„¶åé’ˆå¯¹æ¯ä¸€æ¡æµåº”ç”¨ä¸åŒçš„ä¸šåŠ¡é€»è¾‘.</p>
<h6 id="union"><a href="#union" class="headerlink" title="union"></a>union</h6><p>åˆæµçš„æ–¹å¼ä¸ºFIFOæ–¹å¼,åˆå¹¶æµç±»å‹è¦ä¸€è‡´.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">></span></span> parisStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">></span></span> tokyoStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">></span></span> rioStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">></span></span> allCities <span class="token operator">=</span> parisStream
  <span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>tokyoStream<span class="token punctuation">,</span> rioStream<span class="token punctuation">)</span></code></pre>

<h6 id="connect-comap-coflatmap"><a href="#connect-comap-coflatmap" class="headerlink" title="connect,comap,coflatmap"></a>connect,comap,coflatmap</h6><p>ä¸¤ä¸ªæµçš„æ•°æ®ç±»å‹å¯ä»¥ä¸åŒ,ä¼šå¯¹ä¸¤ä¸ªæµä¸­çš„æ•°æ®åº”ç”¨ä¸åŒçš„å¤„ç†æ–¹æ³•.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">></span></span> one <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> two <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// keyBy two connected streams</span>
<span class="token class-name">ConnectedStreams</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Int</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> keyedConnect1 <span class="token operator">=</span> one
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>two<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// key both input streams on first attribute</span>
<span class="token comment">// alternative: connect two keyed streams</span>
<span class="token class-name">ConnectedStreams</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> keyedConnect2 <span class="token operator">=</span> one
  <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>two<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h5 id="åˆ†å¸ƒå¼è½¬æ¢ç®—å­"><a href="#åˆ†å¸ƒå¼è½¬æ¢ç®—å­" class="headerlink" title="åˆ†å¸ƒå¼è½¬æ¢ç®—å­"></a>åˆ†å¸ƒå¼è½¬æ¢ç®—å­</h5><p>å®šä¹‰äº†äº‹ä»¶å¦‚ä½•åˆ†é…åˆ°ä¸åŒçš„ä»»åŠ¡ä¸­å»</p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨DataStream APIæ¥ç¼–å†™ç¨‹åºæ—¶,ç³»ç»Ÿå°†è‡ªåŠ¨çš„é€‰æ‹©æ•°æ®åˆ†åŒºç­–ç•¥,ç„¶åæ ¹æ®æ“ä½œç¬¦çš„è¯­ä¹‰å’Œè®¾ç½®çš„å¹¶è¡Œåº¦å°†æ•°æ®è·¯ç”±åˆ°æ­£ç¡®çš„åœ°æ–¹å».æœ‰äº›æ—¶å€™,æˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„å±‚é¢æ§åˆ¶åˆ†åŒºç­–ç•¥,æˆ–è€…è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥</p>
<h6 id="random"><a href="#random" class="headerlink" title="random"></a>random</h6><p>éšæœºæ•°æ®äº¤æ¢ç”±<code>DataStream.shuffle()</code>æ–¹æ³•å®ç°ã€‚shuffleæ–¹æ³•å°†æ•°æ®éšæœºçš„åˆ†é…åˆ°ä¸‹æ¸¸ç®—å­çš„å¹¶è¡Œä»»åŠ¡ä¸­å»</p>
<h6 id="round-robin"><a href="#round-robin" class="headerlink" title="round-robin"></a>round-robin</h6><p><code>rebalance()</code>æ–¹æ³•ä½¿ç”¨Round-Robinè´Ÿè½½å‡è¡¡ç®—æ³•å°†è¾“å…¥æµå¹³å‡åˆ†é…åˆ°éšåçš„å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸­å»</p>
<h6 id="rescale"><a href="#rescale" class="headerlink" title="rescale"></a>rescale</h6><p><code>rescale()</code>æ–¹æ³•ä½¿ç”¨çš„ä¹Ÿæ˜¯round-robinç®—æ³•,ä½†åªä¼šå°†æ•°æ®å‘é€åˆ°æ¥ä¸‹æ¥çš„å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸­çš„ä¸€éƒ¨åˆ†ä»»åŠ¡ä¸­.æœ¬è´¨ä¸Š,å½“å‘é€è€…ä»»åŠ¡æ•°é‡å’Œæ¥æ”¶è€…ä»»åŠ¡æ•°é‡ä¸ä¸€æ ·æ—¶,rescaleåˆ†åŒºç­–ç•¥æä¾›äº†ä¸€ç§è½»é‡çº§çš„è´Ÿè½½å‡è¡¡ç­–ç•¥.å¦‚æœæ¥æ”¶è€…ä»»åŠ¡çš„æ•°é‡æ˜¯å‘é€è€…ä»»åŠ¡çš„æ•°é‡çš„å€æ•°æ—¶,rescaleæ“ä½œå°†ä¼šæ•ˆç‡æ›´é«˜.</p>
<p><code>rebalance()</code>å’Œ<code>rescale()</code>çš„æ ¹æœ¬åŒºåˆ«åœ¨äºä»»åŠ¡ä¹‹é—´è¿æ¥çš„æœºåˆ¶ä¸åŒ.<code>rebalance()</code>å°†ä¼šé’ˆå¯¹æ‰€æœ‰å‘é€è€…ä»»åŠ¡å’Œæ‰€æœ‰æ¥æ”¶è€…ä»»åŠ¡ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“,è€Œ<code>rescale()</code>ä»…ä»…é’ˆå¯¹æ¯ä¸€ä¸ªä»»åŠ¡å’Œä¸‹æ¸¸ç®—å­çš„ä¸€éƒ¨åˆ†å­å¹¶è¡Œä»»åŠ¡ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“</p>
<h6 id="broadcast"><a href="#broadcast" class="headerlink" title="broadcast"></a>broadcast</h6><p><code>broadcast()</code>æ–¹æ³•å°†è¾“å…¥æµçš„æ‰€æœ‰æ•°æ®å¤åˆ¶å¹¶å‘é€åˆ°ä¸‹æ¸¸ç®—å­çš„æ‰€æœ‰å¹¶è¡Œä»»åŠ¡ä¸­å».</p>
<h6 id="global"><a href="#global" class="headerlink" title="global"></a>global</h6><p><code>global()</code>æ–¹æ³•å°†æ‰€æœ‰çš„è¾“å…¥æµæ•°æ®éƒ½å‘é€åˆ°ä¸‹æ¸¸ç®—å­çš„ç¬¬ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡ä¸­å».è¿™ä¸ªæ“ä½œéœ€è¦å¾ˆè°¨æ…,å› ä¸ºå°†æ‰€æœ‰æ•°æ®å‘é€åˆ°åŒä¸€ä¸ªtask,å°†ä¼šå¯¹åº”ç”¨ç¨‹åºé€ æˆå¾ˆå¤§çš„å‹åŠ›.</p>
<h6 id="custom"><a href="#custom" class="headerlink" title="custom"></a>custom</h6><p>å½“Flinkæä¾›çš„åˆ†åŒºç­–ç•¥éƒ½ä¸é€‚ç”¨æ—¶,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>partitionCustom()</code>æ–¹æ³•æ¥è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥.è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ª<code>Partitioner</code>å¯¹è±¡,è¿™ä¸ªå¯¹è±¡éœ€è¦å®ç°åˆ†åŒºé€»è¾‘ä»¥åŠå®šä¹‰é’ˆå¯¹æµçš„å“ªä¸€ä¸ªå­—æ®µæˆ–è€…keyæ¥è¿›è¡Œåˆ†åŒº.</p>
<h4 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h4><p>Flinkæ²¡æœ‰ç±»ä¼¼äºsparkä¸­foreachæ–¹æ³•,è®©ç”¨æˆ·è¿›è¡Œè¿­ä»£çš„æ“ä½œ.æ‰€æœ‰å¯¹å¤–çš„è¾“å‡ºæ“ä½œéƒ½è¦åˆ©ç”¨Sinkå®Œæˆ.æœ€åé€šè¿‡ç±»ä¼¼å¦‚ä¸‹æ–¹å¼å®Œæˆæ•´ä¸ªä»»åŠ¡æœ€ç»ˆè¾“å‡ºæ“ä½œ.</p>
<pre class="language-java" data-language="java"><code class="language-java">stream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MySink</span><span class="token punctuation">(</span>xxxx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>å®˜æ–¹æä¾›äº†ä¸€éƒ¨åˆ†çš„æ¡†æ¶çš„sink.é™¤æ­¤ä»¥å¤–,éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰å®ç°sink.</p>
<h5 id="ç¬¬ä¸‰æ–¹sink"><a href="#ç¬¬ä¸‰æ–¹sink" class="headerlink" title="ç¬¬ä¸‰æ–¹sink"></a>ç¬¬ä¸‰æ–¹sink</h5><h6 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h6><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-connector-kafka_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;flink.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> union <span class="token operator">=</span> high
  <span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>low<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">-></span> r<span class="token punctuation">.</span>temperature<span class="token punctuation">.</span>toString<span class="token punctuation">)</span><span class="token punctuation">;</span>

union<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaProducer011</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
    <span class="token string">"localhost:9092"</span><span class="token punctuation">,</span>
    <span class="token string">"test"</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h6><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.bahir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-connector-redis_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisSink_</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">FlinkJedisPoolConfig</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlinkJedisPoolConfig</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        stream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyRedisSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyRedisSink</span> <span class="token keyword">implements</span> <span class="token class-name">RedisMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getKeyFromData</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getValueFromData</span><span class="token punctuation">(</span><span class="token class-name">User</span> <span class="token class-name">User</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">RedisCommandDescription</span> <span class="token function">getCommandDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RedisCommandDescription</span><span class="token punctuation">(</span><span class="token class-name">RedisCommand</span><span class="token punctuation">.</span>HSET<span class="token punctuation">,</span> <span class="token string">"flink-test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-shell" data-language="shell"><code class="language-shell">docker exec -it redis_container_id redis-cli
auth 123456
keys keys flink-test
hvals flink-test</code></pre>

<h6 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h6><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-connector-elasticsearch6_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;flink.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- å¯é€‰ä¾èµ– --></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>7.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>7.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsSink_</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpHost</span><span class="token punctuation">></span></span> httpHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpHosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ElasticsearchSink</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> sensorReadingBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchSink</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
                httpHosts<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token class-name">ElasticsearchSinkFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span>user<span class="token punctuation">,</span> runtimeContext<span class="token punctuation">,</span> requestIndexer<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token class-name">Requests</span>
                            <span class="token punctuation">.</span><span class="token function">indexRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"flink-test"</span><span class="token punctuation">)</span> <span class="token comment">// ç´¢å¼•æ˜¯flink-testï¼Œç›¸å½“äºæ•°æ®åº“</span>
                            <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span> <span class="token comment">// es6éœ€è¦åŠ è¿™ä¸€å¥</span>
                            <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    requestIndexer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        sensorReadingBuilder<span class="token punctuation">.</span><span class="token function">setBulkFlushMaxActions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>sensorReadingBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="è‡ªå®šä¹‰sink"><a href="#è‡ªå®šä¹‰sink" class="headerlink" title="è‡ªå®šä¹‰sink"></a>è‡ªå®šä¹‰sink</h5><p>ç»§æ‰¿ RichSinkFunction æŠ½è±¡ç±»,é‡å†™ invoke æ–¹æ³•</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyJDBCSink</span> <span class="token keyword">extends</span> <span class="token class-name">RichSinkFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> conn<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">PreparedStatement</span> insertStmt<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">PreparedStatement</span> updateStmt<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">User</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        updateStmt<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        updateStmt<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        updateStmt<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateStmt<span class="token punctuation">.</span><span class="token function">getUpdateCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            insertStmt<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            insertStmt<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            insertStmt<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>



<h4 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h4><h5 id="æ—¶é—´-time"><a href="#æ—¶é—´-time" class="headerlink" title="æ—¶é—´ time"></a>æ—¶é—´ time</h5><p>äº‹ä»¶æ—¶é—´ <strong>Event Time</strong>,å³äº‹ä»¶å®é™…å‘ç”Ÿçš„æ—¶é—´,å¯ä»¥å¤„ç†ä¹±åºäº‹ä»¶,ä¸€èˆ¬éƒ½ç”¨è¿™ä¸ª;<br>æ‘„å…¥æ—¶é—´ <strong>Ingestion Time</strong>,äº‹ä»¶è¿›å…¥æµå¤„ç†æ¡†æ¶çš„æ—¶é—´;<br>å¤„ç†æ—¶é—´ <strong>Processing Time</strong>,äº‹ä»¶è¢«å¤„ç†çš„æ—¶é—´,æ‰§è¡Œæ“ä½œç®—å­çš„æœ¬åœ°æ—¶é—´,ä¸æœºå™¨æ— å…³.ç»Ÿè®¡æŸäº›å»¶æ—¶éå¸¸é«˜çš„æ—¥å¿—.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//è®¾ç½®æ—¶é—´å±æ€§ä¸º EventTime</span>
env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic</span><span class="token punctuation">.</span><span class="token class-name">EventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyEvent</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer09</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyEvent</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> schema<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">-></span> event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> a<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// è¿™ä¸ªæ–¹æ³•ä¸­çš„ while å¾ªç¯éƒ¨åˆ†ä¼šä» eventTimeTimersQueue ä¸­ä¾æ¬¡å–å‡ºè§¦å‘æ—¶é—´å°äºå‚æ•° time çš„æ‰€æœ‰å®šæ—¶å™¨ï¼Œè°ƒç”¨ triggerTarget.onEventTime() æ–¹æ³•è¿›è¡Œè§¦å‘ã€‚è¿™å°±æ˜¯ EventTime ä»æ³¨å†Œåˆ°è§¦å‘çš„æµç¨‹ã€‚</span>
<span class="token class-name">InternalTimeServiceImpl</span><span class="token punctuation">.</span>advanceWatermarkã€‚
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">advanceWatermark</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
   currentWatermark <span class="token operator">=</span> time<span class="token punctuation">;</span>
   <span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">></span></span> timer<span class="token punctuation">;</span>

   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timer <span class="token operator">=</span> eventTimeTimersQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> timer<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      eventTimeTimersQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      keyContext<span class="token punctuation">.</span><span class="token function">setCurrentKey</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      triggerTarget<span class="token punctuation">.</span><span class="token function">onEventTime</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="æ°´ä½çº¿-watermark"><a href="#æ°´ä½çº¿-watermark" class="headerlink" title="æ°´ä½çº¿ watermark"></a>æ°´ä½çº¿ watermark</h5><h6 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h6><p><strong>æ°´å°çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å®æ—¶è®¡ç®—ä¸­çš„æ•°æ®ä¹±åºé—®é¢˜ï¼Œå®ƒçš„æœ¬è´¨æ˜¯ DataStream ä¸­ä¸€ä¸ªå¸¦æœ‰æ—¶é—´æˆ³çš„å…ƒç´ </strong>ã€‚</p>
<p>å¦‚æœ Flink ç³»ç»Ÿä¸­å‡ºç°äº†ä¸€ä¸ª WaterMark T,é‚£ä¹ˆå°±æ„å‘³ç€ EventTime &lt; T çš„æ•°æ®éƒ½å·²ç»åˆ°è¾¾,çª—å£çš„ç»“æŸæ—¶é—´å’Œ T ç›¸åŒçš„é‚£ä¸ªçª—å£è¢«<strong>è§¦å‘</strong>è¿›è¡Œè®¡ç®—äº†.</p>
<p>ä¹Ÿå°±æ˜¯è¯´:æ°´å°æ˜¯ Flink åˆ¤æ–­è¿Ÿåˆ°æ•°æ®çš„æ ‡å‡†,åŒæ—¶ä¹Ÿæ˜¯çª—å£è§¦å‘çš„æ ‡è®°.</p>
<p>åœ¨ç¨‹åºå¹¶è¡Œåº¦å¤§äº 1 çš„æƒ…å†µä¸‹,ä¼šæœ‰å¤šä¸ªæµäº§ç”Ÿæ°´å°å’Œçª—å£,è¿™æ—¶å€™ Flink ä¼šé€‰å–æ—¶é—´æˆ³æœ€å°çš„æ°´å°.</p>
<h6 id="ä½¿ç”¨æ°´å°"><a href="#ä½¿ç”¨æ°´å°" class="headerlink" title="ä½¿ç”¨æ°´å°"></a>ä½¿ç”¨æ°´å°</h6><p><strong>a. åœ¨ Source Function ä¸­ ç›´æ¥æŒ‡å®š Timestamps å’Œ Watermark</strong></p>
<p> ç”¨æˆ·éœ€è¦å¤å†™ SourceFunction æ¥å£ä¸­ run( ) æ–¹æ³•å®ç°æ•°æ®é€»è¾‘, åŒæ—¶è°ƒç”¨ SourceContext çš„ collectWithTimestamp( ) æ–¹æ³•ç”Ÿæˆ event time æ—¶é—´æˆ³, è°ƒç”¨ emitWatermark( ) æ–¹æ³•ç”Ÿæˆ watermark.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> text <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> elementInput<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// åˆ‡å‰²æ¯ä¸€æ¡æ•°æ®</span>
                    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inp <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>inp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// ç”Ÿæˆ event time æ—¶é—´æˆ³</span>
                    ctx<span class="token punctuation">.</span><span class="token function">collectWithTimestamp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// è°ƒç”¨ emitWatermark() æ–¹æ³•ç”Ÿæˆ watermark, æœ€å¤§å»¶è¿Ÿè®¾å®šä¸º 2</span>
                    ctx<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// è®¾å®šé»˜è®¤ watermark</span>
                ctx<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><strong>b. é€šè¿‡ Flink è‡ªå¸¦çš„ Timestamp Assigner æŒ‡å®š Timestamp å’Œ ç”Ÿæˆ watermark</strong></p>
<p><strong>b.1 ä½¿ç”¨ Ascending Timestamp Assigner æŒ‡å®š Timestamps å’Œ Watermark</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">></span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>collectionInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
       dataStream<span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span>
               <span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">)</span> context <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">WatermarkGenerator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                   <span class="token keyword">private</span> <span class="token keyword">long</span> maxTimestamp<span class="token punctuation">;</span>
                   <span class="token keyword">private</span> <span class="token keyword">long</span> delay <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
                   <span class="token annotation punctuation">@Override</span>
                   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>
                           <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> event<span class="token punctuation">,</span>
                           <span class="token keyword">long</span> eventTimestamp<span class="token punctuation">,</span>
                           <span class="token class-name">WatermarkOutput</span> output<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                       maxTimestamp <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxTimestamp<span class="token punctuation">,</span> event<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">&#125;</span>
                   <span class="token annotation punctuation">@Override</span>
                   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPeriodicEmit</span><span class="token punctuation">(</span><span class="token class-name">WatermarkOutput</span> output<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                       output<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>maxTimestamp <span class="token operator">-</span> delay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">&#125;</span>
               <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><strong>b.2 å†…ç½®æ°´å°ç”Ÿæˆç­–ç•¥</strong></p>
<p><strong>b.2.1 å›ºå®šå»¶è¿Ÿç”Ÿæˆæ°´å°</strong></p>
<p>é€šè¿‡é™æ€æ–¹æ³•<code>forBoundedOutOfOrderness</code>æä¾›,å…¥å‚æ¥æ”¶ä¸€ä¸ªDurationç±»å‹çš„æ—¶é—´é—´éš”ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥æ¥å—çš„æœ€å¤§çš„å»¶è¿Ÿæ—¶é—´.ä½¿ç”¨è¿™ç§å»¶è¿Ÿç­–ç•¥çš„æ—¶å€™éœ€è¦æˆ‘ä»¬å¯¹æ•°æ®çš„å»¶è¿Ÿæ—¶é—´æœ‰ä¸€ä¸ªå¤§æ¦‚çš„é¢„ä¼°åˆ¤æ–­ã€‚</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span> maxOutOfOrderness<span class="token punctuation">)</span></code></pre>

<p>æˆ‘ä»¬å®ç°ä¸€ä¸ªå»¶è¿Ÿ3ç§’çš„å›ºå®šå»¶è¿Ÿæ°´å°ï¼Œå¯ä»¥è¿™æ ·åšï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span> dataStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">;</span>
dataStream<span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>ä»–çš„åº•å±‚ä½¿ç”¨çš„WatermarkGeneratoræ¥å£çš„ä¸€ä¸ªå®ç°ç±»BoundedOutOfOrdernessWatermarksã€‚æˆ‘ä»¬çœ‹ä¸‹æºç ä¸­çš„è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬ä¸Šé¢è‡ªå·±å†™çš„å¾ˆåƒ.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">T</span> event<span class="token punctuation">,</span> <span class="token keyword">long</span> eventTimestamp<span class="token punctuation">,</span> <span class="token class-name">WatermarkOutput</span> output<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 maxTimestamp <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxTimestamp<span class="token punctuation">,</span> eventTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPeriodicEmit</span><span class="token punctuation">(</span><span class="token class-name">WatermarkOutput</span> output<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 output<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>maxTimestamp <span class="token operator">-</span> outOfOrdernessMillis <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong>b.2.2 å•è°ƒé€’å¢ç”Ÿæˆæ°´å°</strong></p>
<p>é€šè¿‡é™æ€æ–¹æ³•<code>forMonotonousTimestamps</code>æ¥æä¾›.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token function">forMonotonousTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>è¿™ä¸ªä¹Ÿå°±æ˜¯ç›¸å½“äºä¸Šè¿°çš„å»¶è¿Ÿç­–ç•¥å»æ‰äº†å»¶è¿Ÿæ—¶é—´ï¼Œä»¥eventä¸­çš„æ—¶é—´æˆ³å……å½“äº†æ°´å°ã€‚</p>
<p>åœ¨ç¨‹åºä¸­å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span> dataStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">;</span>
dataStream<span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token function">forMonotonousTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>å®ƒçš„åº•å±‚å®ç°æ˜¯AscendingTimestampsWatermarksï¼Œå…¶å®å®ƒå°±æ˜¯BoundedOutOfOrdernessWatermarksç±»çš„ä¸€ä¸ªå­ç±»ï¼Œæ²¡æœ‰äº†å»¶è¿Ÿæ—¶é—´ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“æºç çš„å®ç°.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Public</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AscendingTimestampsWatermarks</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">BoundedOutOfOrdernessWatermarks</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

 <span class="token comment">/**
  * Creates a new watermark generator with for ascending timestamps.
  */</span>
 <span class="token keyword">public</span> <span class="token class-name">AscendingTimestampsWatermarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h6 id="eventæ—¶é—´çš„è·å–"><a href="#eventæ—¶é—´çš„è·å–" class="headerlink" title="eventæ—¶é—´çš„è·å–"></a>eventæ—¶é—´çš„è·å–</h6><p>ä¸Šè¿°æˆ‘ä»¬è®²äº†flinkè‡ªå¸¦çš„ä¸¤ç§æ°´å°ç”Ÿæˆç­–ç•¥ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬ä½¿ç”¨eventtimeè¯­ä¹‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³ä»æˆ‘ä»¬çš„è‡ªå·±çš„æ•°æ®ä¸­æŠ½å–eventtimeï¼Œè¿™ä¸ªå°±éœ€è¦TimestampAssigneräº†.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Public</span>
<span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TimestampAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
 <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">T</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> recordTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬ä¸»è¦å°±æ˜¯ä»æˆ‘ä»¬è‡ªå·±çš„å…ƒç´ elementä¸­æå–æˆ‘ä»¬æƒ³è¦çš„eventtimeã€‚</p>
<p>ä½¿ç”¨flinkè‡ªå¸¦çš„æ°´å°ç­–ç•¥å’ŒeventtimeæŠ½å–ç±»ï¼Œå¯ä»¥è¿™æ ·ç”¨ï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span> dataStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">;</span>
dataStream<span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span>
    <span class="token class-name">WatermarkStrategy</span>
      <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token operator">-></span>event<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="å¤„ç†ç©ºé—²æ•°æ®æº"><a href="#å¤„ç†ç©ºé—²æ•°æ®æº" class="headerlink" title="å¤„ç†ç©ºé—²æ•°æ®æº"></a>å¤„ç†ç©ºé—²æ•°æ®æº</h6><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”±äºæ•°æ®äº§ç”Ÿçš„æ¯”è¾ƒå°‘ï¼Œå¯¼è‡´ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ•°æ®äº§ç”Ÿï¼Œè¿›è€Œå°±æ²¡æœ‰æ°´å°çš„ç”Ÿæˆï¼Œå¯¼è‡´ä¸‹æ¸¸ä¾èµ–æ°´å°çš„ä¸€äº›æ“ä½œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚æŸä¸€ä¸ªç®—å­çš„ä¸Šæ¸¸æœ‰å¤šä¸ªç®—å­ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæ°´å°æ˜¯å–å…¶ä¸Šæ¸¸ä¸¤ä¸ªç®—å­çš„è¾ƒå°å€¼ï¼Œå¦‚æœä¸Šæ¸¸æŸä¸€ä¸ªç®—å­å› ä¸ºç¼ºå°‘æ•°æ®è¿Ÿè¿Ÿæ²¡æœ‰ç”Ÿæˆæ°´å°ï¼Œå°±ä¼šå‡ºç°eventtimeå€¾æ–œé—®é¢˜ï¼Œå¯¼è‡´ä¸‹æ¸¸æ²¡æ³•è§¦å‘è®¡ç®—ã€‚</p>
<p>æ‰€ä»¥filnké€šè¿‡WatermarkStrategy.withIdleness()æ–¹æ³•å…è®¸ç”¨æˆ·åœ¨é…ç½®çš„æ—¶é—´å†…ï¼ˆå³è¶…æ—¶æ—¶é—´å†…ï¼‰æ²¡æœ‰è®°å½•åˆ°è¾¾æ—¶å°†ä¸€ä¸ªæµæ ‡è®°ä¸ºç©ºé—²ã€‚è¿™æ ·å°±æ„å‘³ç€ä¸‹æ¸¸çš„æ•°æ®ä¸éœ€è¦ç­‰å¾…æ°´å°çš„åˆ°æ¥ã€‚</p>
<p>å½“ä¸‹æ¬¡æœ‰æ°´å°ç”Ÿæˆå¹¶å‘å°„åˆ°ä¸‹æ¸¸çš„æ—¶å€™ï¼Œè¿™ä¸ªæ•°æ®æµé‡æ–°å˜æˆæ´»è·ƒçŠ¶æ€ã€‚</p>
<p>é€šè¿‡ä¸‹é¢çš„ä»£ç æ¥å®ç°å¯¹äºç©ºé—²æ•°æ®æµçš„å¤„ç†</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">WatermarkStrategy</span>
        <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withIdleness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h5 id="çª—å£ç®€ä»‹-window"><a href="#çª—å£ç®€ä»‹-window" class="headerlink" title="çª—å£ç®€ä»‹ window"></a>çª—å£ç®€ä»‹ window</h5><p>çª—å£æ˜¯æµå¼è®¡ç®—ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µ, å¾ˆå¤šå¸¸è§çš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡å„ç§çª—å£å®ç°çš„, æ¯”å¦‚æ¯5åˆ†é’Ÿç»Ÿè®¡ä¸€ä¸‹åˆšå»1å°æ—¶çš„çƒ­åº¦. Flink DataStream API å°†çª—å£ç‹¬ç«‹æˆ Operator. æ¯ä¸ªçª—å£ç®—å­åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:</p>
<p><strong>Windows Assigner</strong></p>
<p>æŒ‡å®šçª—å£çš„ç±»å‹, å®šä¹‰å¦‚ä½•å°†æ•°æ®æµåˆ†é…åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªçª—å£</p>
<p><strong>Windows Trigger</strong></p>
<p>æŒ‡å®šçª—å£è§¦å‘çš„æ—¶æœº, å®šä¹‰çª—å£æ»¡è¶³ä»€ä¹ˆæ ·çš„æ¡ä»¶è§¦å‘è®¡ç®—</p>
<p><strong>Evictor</strong></p>
<p>ç”¨æˆ·æ•°æ®å‰”é™¤</p>
<p><strong>Lateness</strong></p>
<p>æ ‡è®°æ˜¯å¦å¤„ç†è¿Ÿåˆ°çš„æ•°æ®, å½“è¿Ÿåˆ°æ•°æ®åˆ°è¾¾çª—å£ä¸­æ˜¯å¦è§¦å‘è®¡ç®—</p>
<p><strong>Output Tag</strong></p>
<p>æ ‡è®°è¾“å‡ºæ ‡ç­¾, ç„¶åå†é€šè¿‡ getSideOutput å°†çª—å£ä¸­çš„æ•°æ®æ ¹æ®æ ‡ç­¾è¾“å‡º</p>
<p><strong>Windows Function</strong></p>
<p>å®šä¹‰çª—å£ä¸Šçš„æ•°æ®å¤„ç†çš„é€»è¾‘, ä¾‹å¦‚å¯¹æ•°æ®è¿›è¡Œsum</p>
<h5 id="Window-Assigner"><a href="#Window-Assigner" class="headerlink" title="Window Assigner"></a>Window Assigner</h5><p>é¦–å…ˆæœ€éœ€è¦äº†è§£çš„å°±æ˜¯ windows Assigneräº†, æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªä»€ä¹ˆæ ·çš„çª—å£åˆ’åˆ†, ä¸»è¦å°±æ˜¯é€šè¿‡ä»–æ¥å®ç°çš„.</p>
<p>æ ¹æ® flink ä¸Šæ¸¸çš„æ•°æ®é›†æ˜¯å¦ä¸º KeyedStream ç±»å‹ æ¥åšåˆ†åˆ«çš„å¤„ç†. å¦‚æœä½¿ç”¨äº†keyBy( ) åˆ™å¯¹åº”ä½¿ç”¨window( ) æ¥å¤„ç†, å¦åˆ™å¯ä»¥ä½¿ç”¨ windowAll( )æ¥ä½¿ç”¨</p>
<p>Flink å¯ä»¥æ”¯æŒä¸¤ç§ç±»å‹çš„çª—å£, åˆ†åˆ«æ˜¯åŸºäºæ—¶é—´çš„çª—å£å’ŒåŸºäºæ•°é‡çš„çª—å£.åŸºäºæ—¶é—´çš„æ„æ€å°±æ˜¯æŒ‰ç…§æ—¶é—´å»åˆ’åˆ†çª—å£,åŒç†,åŸºäºæ•°é‡çš„ä¹Ÿæ˜¯æ ¹æ®çª—å£ä¸­çš„æ•°é‡æ¥åšåˆ‡åˆ†çš„. å¯¹åº”çš„åˆ†åˆ«å°±æ˜¯ timeWindow() å’Œ countWindow() æ¥ä½¿ç”¨, ä¸‹é¢çš„ç¤ºä¾‹ä¸»è¦ä½¿ç”¨ timeWindow() æ¥æ¼”ç¤º.</p>
<p>å¯¹äºä¸åŒçš„ Window Assigner, è¿˜å¯ä»¥æŠŠçª—å£åˆ’åˆ†ä¸º4å¤§ç±», åˆ†åˆ«æ˜¯ æ»šåŠ¨çª—å£(Tumbling Windows) / æ»‘åŠ¨çª—å£(Sliding Window) / ä¼šè¯çª—å£(Session Window) å’Œ å…¨å±€çª—å£(Global Window).</p>
<h6 id="æ»šåŠ¨çª—å£-Tumbling-Windows"><a href="#æ»šåŠ¨çª—å£-Tumbling-Windows" class="headerlink" title="æ»šåŠ¨çª—å£ Tumbling Windows"></a>æ»šåŠ¨çª—å£ Tumbling Windows</h6><p>DataStream API æä¾›åŸºäº EventTime å’Œ ProcessingTime çš„ä¸¤ç§ç±»å‹çš„ Tumbling window.å¯¹åº”çš„ Assigner åˆ†åˆ«æ˜¯ TumblingEventTimeWindow å’Œ ProcessingEventTimeWindow . ä¸¾ä¾‹å¦‚ä¸‹,å®Œæ•´ä»£ç è§Github.</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F; ä½¿ç”¨ProcessTimeçš„æ»šåŠ¨æ—¶é—´çª—å£, é•¿åº¦ä¸º10s
stream.keyBy(x -&gt; x.f1)
    .window(TumblingProcessingTimeWindows.of(Time.seconds(10))).process(...)
&#x2F;&#x2F; ä½¿ç”¨ProcessTimeçš„æ»šåŠ¨æ—¶é—´çª—å£, é•¿åº¦ä¸º10s
stream.keyBy(x -&gt;x.f1).window(TumblingEventTimeWindows.of(Time.seconds(10))).process(...)</code></pre>

<p>ä½¿ç”¨ window(TumblingProcessingTimeWindows.of(Time.seconds(10))) çš„æ–¹æ³•æœ‰ç‚¹å•°å—¦, Flink è¿˜æä¾›äº†timeWindow( ) çš„ API æ¥ç®€åŒ–è¿™ä¸€è¡Œä»£ç .</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F; ç›´æ¥ä½¿ç”¨ timeWindow API ä¾¿å¯å®ç°æ»šåŠ¨çª—å£çš„æ“ä½œ, å‚æ•°ä¾æ—§æ˜¯çª—å£çš„é•¿åº¦
&#x2F;&#x2F; çª—å£ç±»å‹çš„æ—¶é—´ç”± time characteristic ç¡®å®š, å¦‚æœæŒ‡å®šä¸º event time,é‚£ä¹ˆçª—å£ä¹Ÿä¼šè‡ªåŠ¨ç”¨è¿™ä¸ªæ—¶é—´
input.keyBy(x -&gt; x.f1).timeWindow(Time.seconds(10));</code></pre>

<h6 id="æ»‘åŠ¨çª—å£-Sliding-Window"><a href="#æ»‘åŠ¨çª—å£-Sliding-Window" class="headerlink" title="æ»‘åŠ¨çª—å£ Sliding Window"></a>æ»‘åŠ¨çª—å£ Sliding Window</h6><p>æ»‘åŠ¨çª—å£é¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªåœ¨ä¸æ–­å¾€åæ»‘åŠ¨çš„çª—å£, æ¯”å¦‚è¯´ æ¯5åˆ†é’Ÿ ç»Ÿè®¡ä¸€ä¸ª æœ€è¿‘ä¸€å°æ—¶çš„æ—¶é—´, é‚£ä¹ˆå°±éœ€è¦ç”¨æ»‘åŠ¨çª—å£æ¥åšå¤„ç†. æ»‘åŠ¨çª—å£ä¸»è¦æ˜¯ä¾é  window size å’Œ slide time æ¥ç¡®å®š. ä¸æ»šåŠ¨çª—å£ç±»ä¼¼çš„, flink ä¹Ÿæä¾›äº†å¯¹åº”ä¸åŒæ—¶é—´çš„ Assigner API(SlidingEventTimeWindow / SlidingEventTimeWindow), è¯­æ³•åŸºæœ¬ç±»ä¼¼, åªæ˜¯ç”±åŸæœ¬çš„ä¸€ä¸ªå‚æ•°(çª—å£é•¿åº¦) å˜ä¸ºäº†ä¸¤ä¸ªå‚æ•°(çª—å£é•¿åº¦å’Œæ»‘åŠ¨æ—¶é—´), åŒæ ·çš„, ä¸ºäº†ç®€åŒ–ä»£ç , ä¾ç„¶å¯ä»¥ä½¿ç”¨timeWindow() æ¥ç®€åŒ–.</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F; ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ çª—å£é•¿åº¦ å’Œ æ»‘åŠ¨æ—¶é—´, çª—å£æ—¶é—´ç±»å‹ä¾æ—§é€šè¿‡time characteristic ç¡®å®š
input.keyBy(x -&gt; x.f1).timeWindow(Time.seconds(10), Time.seconds(1))</code></pre>

<h6 id="ä¼šè¯çª—å£-Session-Window"><a href="#ä¼šè¯çª—å£-Session-Window" class="headerlink" title="ä¼šè¯çª—å£ Session Window"></a>ä¼šè¯çª—å£ Session Window</h6><p>ä¼šè¯çª—å£ä¸»è¦æ˜¯å°†æŸæ®µæ—¶é—´å†…æ´»è·ƒåº¦è¾ƒé«˜çš„æ•°æ®èšåˆæˆä¸€ä¸ªçª—å£è®¡ç®—. è§¦å‘æ¡ä»¶æ˜¯ Session Gap. åœ¨è§„å®šçš„æ—¶é—´å†…æ²¡æœ‰æ•°æ®æ¥å…¥åˆ™è®¤ä¸ºè¿™ä¸ªçª—å£ç»“æŸ,ç„¶åè§¦å‘çª—å£è®¡ç®—. Session Gap é™¤äº†å›ºå®šé—´éš”çš„æ–¹å¼, ä¹Ÿå¯ä»¥åŠ¨æ€æŠ½å–.</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F; åˆ›å»º Session Window, é—´éš”ä¸º 3s
        DataStream&lt;Tuple3&lt;String, Long, Integer&gt;&gt; aggregated &#x3D; source
                .keyBy(0)
                .window(EventTimeSessionWindows.withGap(Time.seconds(3L)))
                .sum(2);</code></pre>

<h6 id="å…¨å±€çª—å£-Global-Window"><a href="#å…¨å±€çª—å£-Global-Window" class="headerlink" title="å…¨å±€çª—å£ Global Window"></a>å…¨å±€çª—å£ Global Window</h6><p>å…¨å±€çª—å£å°†æ‰€æœ‰keyçš„æ•°æ®åˆ†é…åˆ°å•ä¸ªçª—å£ä¸­è®¡ç®—ç»“æœ.</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F; åˆ›å»º GlobalWindow
        input.keyBy(1)
                .window(GlobalWindows.create())
                .sum(1);</code></pre>

<h5 id="Window-Function"><a href="#Window-Function" class="headerlink" title="Window Function"></a>Window Function</h5><p>Window Assigner çš„ä½œç”¨æ˜¯åˆ’åˆ†çª—å£çš„, è€Œ Window Function å°±æ˜¯å¯¹çª—å£å†…çš„æ•°æ®åšå¤„ç†çš„ä¸€ä¸ªè¿‡ç¨‹</p>
<h6 id="ReduceFunction-å¢é‡"><a href="#ReduceFunction-å¢é‡" class="headerlink" title="ReduceFunction (å¢é‡)"></a>ReduceFunction (å¢é‡)</h6><p>å¯¹è¾“å…¥çš„ä¸¤ä¸ªç›¸åŒç±»å‹çš„å…ƒç´ æŒ‰ç…§æŒ‡å®šçš„è®¡ç®—æ–¹å¼è¿›è¡Œèšåˆ, é€šè¿‡å®ç° ReduceFunction æ¥å£å°±å¯ä»¥åœ¨reduce( ) å‡½æ•°å†…éƒ¨è¿›è¡Œèšåˆæ“ä½œäº†.</p>
<pre class="language-java" data-language="java"><code class="language-java">input<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>x <span class="token operator">-></span> x<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span>t2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>f0 <span class="token operator">+</span> t2<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> t1<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h6 id="AggregateFunction-å¢é‡"><a href="#AggregateFunction-å¢é‡" class="headerlink" title="AggregateFunction (å¢é‡)"></a>AggregateFunction (å¢é‡)</h6><p>AggregateFunction ç›¸å¯¹äºReduceFunctionæ›´åŠ çµæ´»,ä½†æ˜¯å®ç°èµ·æ¥ä¹Ÿæ›´å¤æ‚, AggregateFunctionæœ‰ 4 ä¸ªéœ€è¦å¤å†™çš„æ–¹æ³•, å…¶ä¸­createAccumulator( ) å®šä¹‰ç´¯åŠ å™¨, add( ) å®šä¹‰æ•°æ®çš„æ·»åŠ é€»è¾‘, getResult( ) å®šä¹‰äº†æ ¹æ® accumulator è®¡ç®—ç»“æœçš„é€»è¾‘, merge()æ–¹æ³•å®šä¹‰åˆå¹¶ accumulator çš„é€»è¾‘.</p>
<pre class="language-java" data-language="java"><code class="language-java">input<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>x <span class="token operator">-></span> x<span class="token punctuation">.</span>f1<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// è‡ªå®šä¹‰ä¸€ä¸ªAggregateFunciton, å°†ç›¸åŒæ ‡å· f1 çš„æ•°æ®çš„ f0å­—ç¬¦ä¸²å­—æ®µåˆå¹¶åœ¨ä¸€èµ·</span>
    <span class="token comment">// ("hello", 1L) + ("world", 1L) = ("hello world", 1L)</span>
    <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyAggregateFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>é€šè¿‡è‡ªå®šä¹‰çš„ MyAggregateFunction() æ¥å®ç° AggregateFunction æ¥å£</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyAggregateFunction</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        	<span class="token comment">// åˆå§‹åŒ–ç´¯åŠ å™¨</span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> t<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// è¾“å…¥æ•°æ®ä¸ç´¯åŠ å™¨çš„åˆå¹¶</span>
            <span class="token keyword">return</span> s <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span>t<span class="token punctuation">.</span>f0<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// å¾—åˆ°ç´¯åŠ å™¨çš„ç»“æœ</span>
            <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">String</span> acc1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// åˆå¹¶ç´¯åŠ å™¨</span>
            <span class="token keyword">return</span> s <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> acc1<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span></code></pre>

<h6 id="FoldFunction-å¢é‡"><a href="#FoldFunction-å¢é‡" class="headerlink" title="FoldFunction (å¢é‡)"></a>FoldFunction (å¢é‡)</h6><p>FoldFunctionå®šä¹‰äº†å¦‚ä½•å°†çª—å£ä¸­çš„è¾“å…¥å…ƒç´ ä¸å¤–éƒ¨çš„å…ƒç´ åˆå¹¶çš„é€»è¾‘</p>
<pre class="language-java" data-language="java"><code class="language-java">input<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>x <span class="token operator">-></span> x<span class="token punctuation">.</span>f1<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token string">"flink"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>acc<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">-></span>t<span class="token punctuation">.</span>f0 <span class="token operator">+</span> acc<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>FoldFunctionåœ¨æ–°ç‰ˆæœ¬å·²ç»è¢«æ ‡è®°@Deprecatedäº†, å»ºè®®ä½¿ç”¨AggregateFunctionä»£æ›¿</p>
<h6 id="ProcessWindowFunction-å…¨é‡"><a href="#ProcessWindowFunction-å…¨é‡" class="headerlink" title="ProcessWindowFunction (å…¨é‡)"></a>ProcessWindowFunction (å…¨é‡)</h6><p>ProcessWindowFunction ç›¸è¾ƒäºå…¶ä»–çš„ Window Function, å¯ä»¥å®ç°ä¸€äº›æ›´å¤æ‚çš„è®¡ç®—, æ¯”å¦‚åŸºäºæ•´ä¸ªçª—å£åšæŸäº›æŒ‡æ ‡è®¡ç®— æˆ–è€…éœ€è¦æ“ä½œçª—å£ä¸­çš„çŠ¶æ€æ•°æ®å’Œçª—å£å…ƒæ•°æ®. Flink æä¾›äº† ProcessWindowFunction è¿™ä¸ªæŠ½è±¡ç±», ç»§æ‰¿æ­¤ç±»å°±å¯ä»¥å®ç°ProcessWindowFunction, å…¶ä¸­, å¿…é¡»è¦å®ç° process( ) æ–¹æ³•, è¿™æ˜¯å¤„ç†çª—å£æ•°æ®çš„ä¸»è¦æ–¹æ³•.è¿˜åœ¨ä¸€ä¸‹è·Ÿçª—å£æ•°æ®ç›¸å…³çš„æ–¹æ³•å¯ä»¥æœ‰é€‰æ‹©çš„å®ç°.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyProcessWindowFunction</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Long</span> s<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">></span></span> 		elements<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// ç»Ÿè®¡æ¯ä¸ªçª—å£å†…çš„æ‰€æœ‰æ•°æ®çš„ f0å­—æ®µåŠ èµ·æ¥å…±æœ‰å¤šå°‘ä¸ªå•è¯</span>
        <span class="token comment">// ä¹Ÿå°±åšå•ä¸ªçª—å£çš„ wordcount</span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> element <span class="token operator">:</span> elements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            count <span class="token operator">+=</span> element<span class="token punctuation">.</span>f0<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token string">"window: "</span> <span class="token operator">+</span> context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" word count: "</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="Window-Join"><a href="#Window-Join" class="headerlink" title="Window Join"></a>Window Join</h5><p>Flink ä¸­æ”¯æŒçª—å£ä¸Šçš„å¤šæµåˆå¹¶, éœ€è¦ä¿è¯çš„æ˜¯è¾“å…¥çš„ stream è¦æ„å»ºåœ¨ç›¸åŒçš„ Window ä¸Š, å¹¶ä½¿ç”¨ç›¸åŒç±»å‹çš„ Key ä½œä¸ºå…³è”æ¡ä»¶.</p>
<pre class="language-java" data-language="java"><code class="language-java">inputStream1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>inputStream2<span class="token punctuation">)</span>
			<span class="token comment">// æŒ‡å®šinputStream1çš„å…³è”key</span>
			<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token comment">// æŒ‡å®šinputStream2çš„å…³è”key</span>
			<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token comment">// æŒ‡å®š window Assigner</span>
			<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">// æŒ‡å®šçª—å£è®¡ç®—å‡½æ•°</span>
			<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JoinFunction</span><span class="token punctuation">></span></span><span class="token punctuation">)</span></code></pre>

<h5 id="å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ "><a href="#å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ " class="headerlink" title="å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ "></a>å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ </h5><p>è¿Ÿåˆ°çš„å…ƒç´ æ˜¯æŒ‡å½“è¿™ä¸ªå…ƒç´ æ¥åˆ°æ—¶,è¿™ä¸ªå…ƒç´ æ‰€å¯¹åº”çš„çª—å£å·²ç»è®¡ç®—å®Œæ¯•äº†(ä¹Ÿå°±æ˜¯è¯´æ°´ä½çº¿å·²ç»æ²¡è¿‡çª—å£ç»“æŸæ—¶é—´äº†).è¿™è¯´æ˜è¿Ÿåˆ°è¿™ä¸ªç‰¹æ€§åªé’ˆå¯¹äº‹ä»¶æ—¶é—´.</p>
<p>DataStream APIæä¾›äº†ä¸‰ç§ç­–ç•¥æ¥å¤„ç†è¿Ÿåˆ°å…ƒç´ </p>
<h6 id="ç›´æ¥æŠ›å¼ƒ"><a href="#ç›´æ¥æŠ›å¼ƒ" class="headerlink" title="ç›´æ¥æŠ›å¼ƒ"></a>ç›´æ¥æŠ›å¼ƒ</h6><p>æŠ›å¼ƒè¿Ÿåˆ°çš„å…ƒç´ æ˜¯event time window operatorçš„é»˜è®¤è¡Œä¸º.ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªè¿Ÿåˆ°çš„å…ƒç´ ä¸ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£.</p>
<p>process functionå¯ä»¥é€šè¿‡æ¯”è¾ƒè¿Ÿåˆ°å…ƒç´ çš„æ—¶é—´æˆ³å’Œå½“å‰æ°´ä½çº¿çš„å¤§å°æ¥å¾ˆè½»æ˜“çš„è¿‡æ»¤æ‰è¿Ÿåˆ°å…ƒç´ .</p>
<h6 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h6><p>è¿Ÿåˆ°çš„å…ƒç´ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¾§è¾“å‡º(side output)ç‰¹æ€§è¢«é‡å®šå‘åˆ°å¦å¤–çš„ä¸€æ¡æµä¸­å».è¿Ÿåˆ°å…ƒç´ æ‰€ç»„æˆçš„ä¾§è¾“å‡ºæµå¯ä»¥ç»§ç»­å¤„ç†æˆ–è€…sinkåˆ°æŒä¹…åŒ–è®¾æ–½ä¸­å».</p>
<h6 id="æ›´æ–°çª—å£è®¡ç®—ç»“æœ"><a href="#æ›´æ–°çª—å£è®¡ç®—ç»“æœ" class="headerlink" title="æ›´æ–°çª—å£è®¡ç®—ç»“æœ"></a>æ›´æ–°çª—å£è®¡ç®—ç»“æœ</h6><p>ç”±äºå­˜åœ¨è¿Ÿåˆ°çš„å…ƒç´ ,æ‰€ä»¥å·²ç»è®¡ç®—å‡ºçš„çª—å£ç»“æœæ˜¯ä¸å‡†ç¡®å’Œä¸å®Œå…¨çš„.æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿Ÿåˆ°å…ƒç´ æ›´æ–°å·²ç»è®¡ç®—å®Œçš„çª—å£ç»“æœ.</p>
<p>window operator APIæä¾›äº†æ–¹æ³•æ¥æ˜ç¡®å£°æ˜æˆ‘ä»¬è¦ç­‰å¾…è¿Ÿåˆ°å…ƒç´ .å½“ä½¿ç”¨event-time window,æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªæ—¶é—´æ®µå«åš<code>allowed lateness</code>.window operatorå¦‚æœè®¾ç½®äº†<code>allowed lateness</code>,è¿™ä¸ªwindow operatoråœ¨æ°´ä½çº¿æ²¡è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶ä¹Ÿå°†ä¸ä¼šåˆ é™¤çª—å£å’Œçª—å£ä¸­çš„çŠ¶æ€.çª—å£ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…(allowed latenessè®¾ç½®çš„)ä¿ç•™æ‰€æœ‰çš„å…ƒç´ .</p>
<p>å½“è¿Ÿåˆ°å…ƒç´ åœ¨<code>allowed lateness</code>æ—¶é—´å†…åˆ°è¾¾æ—¶,è¿™ä¸ªè¿Ÿåˆ°å…ƒç´ ä¼šè¢«å®æ—¶å¤„ç†å¹¶å‘é€åˆ°è§¦å‘å™¨(trigger).å½“æ°´ä½çº¿æ²¡è¿‡äº†çª—å£ç»“æŸæ—¶é—´+allowed latenessæ—¶é—´æ—¶,çª—å£ä¼šè¢«åˆ é™¤,å¹¶ä¸”æ‰€æœ‰åæ¥çš„è¿Ÿåˆ°çš„å…ƒç´ éƒ½ä¼šè¢«ä¸¢å¼ƒ.</p>
<h4 id="State"><a href="#State" class="headerlink" title="State"></a>State</h4><p>å®˜æ–¹æ–‡æ¡£æœ‰è¯¦ç»†æè¿°,è¿™é‡Œä¸å¤šèµ˜è¿°.</p>
<p><a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/zh/dev/stream/state/state.html">https://ci.apache.org/projects/flink/flink-docs-release-1.11/zh/dev/stream/state/state.html</a></p>
<h4 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h4><p>Flinkæœ¬èº«æ˜¯æ‰¹æµç»Ÿä¸€çš„å¤„ç†æ¡†æ¶,æ‰€ä»¥Table APIå’ŒSQL,å°±æ˜¯æ‰¹æµç»Ÿä¸€çš„ä¸Šå±‚å¤„ç†API.ç›®å‰è¿˜åœ¨å®Œå–„ä¸­,æ‰€ä»¥åé¢å¾…å®Œå–„.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">compileOnly <span class="token string gstring">"org.apache.flink:flink-table-api-java-bridge_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>scalaBinaryVersion<span class="token punctuation">&#125;</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>flinkVersion<span class="token punctuation">&#125;</span></span>"</span>
<span class="token comment">// æœ¬åœ°è¿è¡Œï¼Œçº¿ä¸Šlibå·²ç»åŒ…å«ï¼Œä¸éœ€è¦å¼•å…¥</span>
compileOnly <span class="token string gstring">"org.apache.flink:flink-table-planner-blink_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>scalaBinaryVersion<span class="token punctuation">&#125;</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>flinkVersion<span class="token punctuation">&#125;</span></span>"</span>
<span class="token comment">// è‡ªå®šä¹‰å‡½æ•°ï¼Œçº¿ä¸Šlibå·²ç»åŒ…å«ï¼Œä¸éœ€è¦å¼•å…¥</span>
compileOnly <span class="token string gstring">"org.apache.flink:flink-table-common:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>flinkVersion<span class="token punctuation">&#125;</span></span>"</span></code></pre>

<p><strong>æœªå®Œå¾…ç»­â€¦..</strong></p>
<h3 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h3><p><a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/">apache flink</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/flink">github flink</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/zhisheng17/flink-learning">github flink-learning</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/CheckChe0803/flink-simple-tutorial">github flink-simple-tutorial</a></p>
<p><a target="_blank" rel="noopener" href="https://confucianzuoyuan.github.io/flink-tutorial/">å°šç¡…è°·</a></p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">Buye me a cup of coffee or ice coke.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://blog.res.jianchengwang.info/alipay.PNG"><img loading="lazy" src="https://blog.res.jianchengwang.info/alipay.PNG" alt="Alipay" title="Alipay"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://blog.res.jianchengwang.info/wxpay.PNG"><img loading="lazy" src="https://blog.res.jianchengwang.info/wxpay.PNG" alt="WechatPay" title="WechatPay"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>jiancheng_wang</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://jianchengwang.info/2020/11/03/java/middleware/flink/" title="flink">https://jianchengwang.info/2020/11/03/java/middleware/flink/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless stating additionally.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/11/11/python/da/pandas/" rel="prev" title="pandas"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">pandas</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/11/01/linux/dist/debian/" rel="next" title="debian"><span class="post-nav-text">debian</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>ç‚¹å‡»æŒ‰é’®è·³è½¬ GitHub Issues è¯„è®ºã€‚</span><br><span>è‹¥æ²¡æœ‰æœ¬æ–‡ Issueï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Comment æ¨¡ç‰ˆæ–°å»ºã€‚</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/jianchenwang/jianchengwang.github.io/issues?q=is:issue+flink">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">é—½ICPå¤‡16000680å·</a></div><div class="copyright"><span>&copy; 2020 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> jiancheng_wang</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.2.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.2.0</span></div><div class="footer-custom-text"><a style="display:inline-block" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="blank" title="åˆæ‹äº‘"><img height="30" src="https://blog.res.jianchengwang.info/upyun-logo.png" alt="upyun"/></a></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script><!-- hexo injector body_end start --><script src="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.0.5/js/index.js"></script><div id="widget-tree">
      <ul><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/java/">java</a><ul class="tree-list-children"><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/java/javase/">javase</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/java/javase/java8/" title="java8"><i class="post-icon gg-file-document"></i>java8</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/java/middleware/">middleware</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/java/middleware/canal/" title="canal"><i class="post-icon gg-file-document"></i>canal</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/java/middleware/nacos/" title="nacos"><i class="post-icon gg-file-document"></i>nacos</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/11/03/java/middleware/flink/" title="flink"><i class="post-icon gg-file-document"></i>flink</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/java/tool/">tool</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/java/tool/Gradle/" title="gradle"><i class="post-icon gg-file-document"></i>gradle</a></li></ul></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/linux/">linux</a><ul class="tree-list-children"><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/linux/dist/">dist</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/11/01/linux/dist/debian/" title="debian"><i class="post-icon gg-file-document"></i>debian</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/linux/dist/manjaro/" title="manjaro"><i class="post-icon gg-file-document"></i>manjaro</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/linux/dist/centos7/" title="centos7"><i class="post-icon gg-file-document"></i>centos7</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/linux/sh/">sh</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/linux/sh/curl/" title="curl"><i class="post-icon gg-file-document"></i>curl</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/linux/sh/tlcl/" title="tlcl"><i class="post-icon gg-file-document"></i>tlcl</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/linux/soft/">soft</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/linux/soft/docker/" title="docker"><i class="post-icon gg-file-document"></i>docker</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/linux/soft/git/" title="git"><i class="post-icon gg-file-document"></i>git</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/linux/ssh/">ssh</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/linux/sh/ssh/" title="ssh"><i class="post-icon gg-file-document"></i>ssh</a></li></ul></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/play/">play</a><ul class="tree-list-children"><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/play/gfw/">gfw</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/play/gfw/vps/" title="vps"><i class="post-icon gg-file-document"></i>vps</a></li></ul></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/python/">python</a><ul class="tree-list-children"><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/python/da/">da</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/11/11/python/da/pandas/" title="pandas"><i class="post-icon gg-file-document"></i>pandas</a></li></ul></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/store/">store</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/store/%E6%96%AD%E5%88%80%E6%AE%8B%E9%9B%AA/" title="æ–­åˆ€æ®‹é›ª"><i class="post-icon gg-file-document"></i>æ–­åˆ€æ®‹é›ª</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/store/%E9%95%BF%E5%AE%89%E4%B9%B1/" title="é•¿å®‰ä¹±"><i class="post-icon gg-file-document"></i>é•¿å®‰ä¹±</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/store/%E6%98%8E%E6%9C%88%E6%B3%AA/" title="æ˜æœˆæ³ª"><i class="post-icon gg-file-document"></i>æ˜æœˆæ³ª</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/store/%E6%B8%A9%E6%9F%94%E5%88%80/" title="æ¸©æŸ”åˆ€"><i class="post-icon gg-file-document"></i>æ¸©æŸ”åˆ€</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/store/%E5%A4%A7%E8%8D%92/" title="å¤§è’"><i class="post-icon gg-file-document"></i>å¤§è’</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/web/">web</a><ul class="tree-list-children"><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/web/css/">css</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/11/12/web/css/web-design-in-4-minutes/" title="web-design-in-4-minutes"><i class="post-icon gg-file-document"></i>web-design-in-4-minutes</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/web/js/">js</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/web/js/functional-programming-in-javascript/" title="Functional Programming in JavaScript"><i class="post-icon gg-file-document"></i>Functional Programming in JavaScript</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/web/js/this-in-javascript/" title="JSä¸­çš„thisæœºåˆ¶"><i class="post-icon gg-file-document"></i>JSä¸­çš„thisæœºåˆ¶</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/web/js/es6/" title="es6"><i class="post-icon gg-file-document"></i>es6</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/web/live2d/">live2d</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/11/12/web/live2d/live2d-web/" title="live2d-web"><i class="post-icon gg-file-document"></i>live2d-web</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/web/vue/">vue</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/web/vue/electron-vue/" title="electron-vue"><i class="post-icon gg-file-document"></i>electron-vue</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/2020/10/27/web/vue/intro-to-vue/" title="intro to vue"><i class="post-icon gg-file-document"></i>intro to vue</a></li></ul></li></ul></li></ul>
        <div id="widget-tree-button">
          <i class="gg-chevron-right"></i>
        </div>
      </div><!-- hexo injector body_end end --></body></html>